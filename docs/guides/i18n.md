# Internationalization (i18n) Guide

## Architecture Overview

Vamsa uses **react-i18next** with bundled JSON resources (no lazy loading). Translations are loaded at build time and included in the client bundle.

- **Config**: `apps/web/src/i18n/config.ts`
- **Languages**: English (`en`), Hindi (`hi`), Spanish (`es`)
- **Default language**: English
- **Fallback**: English (if a key is missing in the selected language)
- **Detection**: Client-side via localStorage → browser navigator → HTML lang attribute

### Server-Side i18n

A separate i18n instance exists for server-side translations (error messages, emails, etc.):

- **Config**: `packages/lib/src/server/i18n/index.ts`
- **Backend**: `i18next-fs-backend` (reads JSON files from disk)
- **Usage**: `await t("errors:auth.invalidCredentials", {}, userLanguage)`

## File Structure

```
apps/web/src/i18n/
├── config.ts                    # Client-side i18n configuration
└── locales/
    ├── en.json                  # Legacy monolithic English (fallback only)
    ├── hi.json                  # Legacy monolithic Hindi (fallback only)
    ├── en/
    │   ├── common.json          # Shared buttons, labels, pagination, validation
    │   ├── auth.json            # Login, register, password flows
    │   ├── people.json          # Person forms, relationships, events, places, sources
    │   ├── errors.json          # All error messages (server + client)
    │   ├── navigation.json      # Nav items, search UI, command palette
    │   ├── dashboard.json       # Dashboard widgets, onboarding, setup
    │   ├── charts.json          # Chart types, controls, export, statistics
    │   └── admin.json           # Settings, backup, users, invites, suggestions
    ├── hi/
    │   └── (same files as en/)
    └── es/
        └── (same files as en/)

packages/lib/src/server/i18n/
└── index.ts                     # Server-side i18n singleton
```

## Namespaces

| Namespace    | Purpose                                               | Key count |
| ------------ | ----------------------------------------------------- | --------- |
| `common`     | Shared UI: buttons, labels, pagination, errors, forms | ~80       |
| `auth`       | Authentication: login, register, password, SSO        | ~70       |
| `people`     | People: forms, relationships, events, places, sources | ~60       |
| `errors`     | Error messages: auth, validation, server, permissions  | ~70       |
| `navigation` | Navigation: sidebar, search, command palette          | ~55       |
| `dashboard`  | Dashboard: widgets, onboarding, setup wizard          | ~35       |
| `charts`     | Charts: types, controls, export, statistics           | ~55       |
| `admin`      | Admin: settings, users, invites, backup, GEDCOM       | ~90       |

## How to Add a New Translation Key

### Step 1: Add to English JSON

Edit the appropriate namespace file in `apps/web/src/i18n/locales/en/`:

```json
// en/common.json
{
  "existingKey": "Existing value",
  "myNewButton": "Click Me"
}
```

### Step 2: Add to Hindi JSON

```json
// hi/common.json
{
  "existingKey": "मौजूदा मान",
  "myNewButton": "मुझे क्लिक करें"
}
```

### Step 3: Add to Spanish JSON

```json
// es/common.json
{
  "existingKey": "Valor existente",
  "myNewButton": "Haz clic"
}
```

### Step 4: Use in Component

```tsx
import { useTranslation } from "react-i18next";

function MyComponent() {
  const { t } = useTranslation("common");
  return <button>{t("myNewButton")}</button>;
}
```

## How to Add a New Namespace

### Step 1: Create JSON files

Create the namespace JSON for all 3 languages:

```
apps/web/src/i18n/locales/en/myNamespace.json
apps/web/src/i18n/locales/hi/myNamespace.json
apps/web/src/i18n/locales/es/myNamespace.json
```

### Step 2: Update client config

Edit `apps/web/src/i18n/config.ts`:

```ts
// Add imports
import enMyNamespace from "./locales/en/myNamespace.json";
import hiMyNamespace from "./locales/hi/myNamespace.json";
import esMyNamespace from "./locales/es/myNamespace.json";

// Add to resources
const resources = {
  en: {
    // ...existing
    myNamespace: enMyNamespace,
  },
  hi: {
    // ...existing
    myNamespace: hiMyNamespace,
  },
  es: {
    // ...existing
    myNamespace: esMyNamespace,
  },
};

// Add to ns array
i18n.use(initReactI18next).init({
  // ...
  ns: [
    // ...existing
    "myNamespace",
  ],
});
```

### Step 3: Update server config (if needed)

Edit `packages/lib/src/server/i18n/index.ts`:

```ts
ns: [
  // ...existing
  "myNamespace",
],
```

## How to Add a New Language

### Step 1: Create locale files

Create all namespace JSON files for the new locale:

```
apps/web/src/i18n/locales/fr/common.json
apps/web/src/i18n/locales/fr/auth.json
apps/web/src/i18n/locales/fr/people.json
apps/web/src/i18n/locales/fr/errors.json
apps/web/src/i18n/locales/fr/navigation.json
apps/web/src/i18n/locales/fr/dashboard.json
apps/web/src/i18n/locales/fr/charts.json
apps/web/src/i18n/locales/fr/admin.json
```

### Step 2: Update config.ts

```ts
// Add imports for all French namespace files
import frCommon from "./locales/fr/common.json";
// ... all other namespaces

// Add to SUPPORTED_LANGUAGES
export const SUPPORTED_LANGUAGES = {
  en: "English",
  hi: "हिन्दी (Hindi)",
  es: "Español (Spanish)",
  fr: "Français (French)",
} as const;

// Add to resources
const resources = {
  // ...existing
  fr: {
    translation: enTranslations, // Fallback to English
    common: frCommon,
    // ... all namespaces
  },
};
```

### Step 3: Update language switcher

The language switcher in `apps/web/src/components/layout/language-switcher.tsx` reads from `SUPPORTED_LANGUAGES`, so it will automatically pick up the new language.

### Step 4: Update server config

Add the new locale to `packages/lib/src/server/i18n/index.ts` if server-side translations are needed.

## Component Patterns

### Single namespace

```tsx
const { t } = useTranslation("dashboard");
// t("title") → looks up "title" in dashboard namespace
```

### Multiple namespaces

```tsx
const { t } = useTranslation(["dashboard", "common"]);
// t("title") → looks up "title" in dashboard (first namespace)
// t("common:save") → looks up "save" in common namespace
```

### Cross-namespace reference

```tsx
const { t } = useTranslation("people");
// Use prefix for other namespaces:
t("common:save")     // → "Save" from common namespace
t("common:cancel")   // → "Cancel" from common namespace
```

### Interpolation

```tsx
// JSON: "greeting": "Hello, {{name}}"
t("greeting", { name: userName })

// JSON: "minLength": "Must be at least {{length}} characters"
t("common:minLength", { length: 8 })
```

### Plurals

```tsx
// JSON:
// "itemCount_one": "{{count}} item"
// "itemCount_other": "{{count}} items"
t("itemCount", { count: items.length })
```

### Non-component usage (data files)

For files that aren't React components (like `command-palette-data.ts`), convert static data to a function that accepts `t`:

```ts
import type { TFunction } from "i18next";

export function getNavigationItems(t: TFunction) {
  return [
    { label: t("navigation:navDashboard"), href: "/dashboard" },
    { label: t("navigation:navPeople"), href: "/people" },
  ];
}
```

Then call it from the component where you have the `t` function:

```tsx
const { t } = useTranslation("navigation");
const items = getNavigationItems(t);
```

## What NOT to Translate

- **Person names** — come from the database, user-entered
- **Place names** — geographic data from the database
- **Relationship labels from DB** — e.g., "Father", "Mother" if stored as data
- **API error codes** — use `errors` namespace for display messages instead
- **Technical identifiers** — URLs, email addresses, IDs
- **Console/logger messages** — these are for developers, not users
- **CSS classes, HTML attributes** — `data-*`, `id`, `className`

## Translation Quality Checklist

1. All 3 locale files (en, hi, es) have the same keys
2. No raw translation keys visible in the UI (test by switching languages)
3. Interpolation variables (`{{name}}`, `{{count}}`) match across all languages
4. Hindi text uses Devanagari script (not transliteration)
5. Spanish text uses proper accents and punctuation (inverted `?` and `!`)
6. Button/label text fits the UI in all languages (some translations are longer)
7. `bun run build` succeeds with no missing import errors

## Testing Translations

### Manual Testing

1. Start dev server: `bun run dev`
2. Open the app in browser
3. Use the language switcher (top-right) to switch to Hindi
4. Navigate through all pages — verify no raw keys like `common:save` appear
5. Switch to Spanish — repeat
6. Switch back to English — verify everything still works

### Automated Checks

```bash
# Type check (catches missing imports)
bun run typecheck

# Unit tests
bun run test

# Build (catches bundling issues)
bun run build
```

## Language Persistence

User language preference is persisted in two places:

1. **Client**: `localStorage` key `i18nextLng` (automatic via i18next-browser-languagedetector)
2. **Server**: `users.preferredLanguage` column in the database (via `setUserLanguagePreference` server function)

When a user switches languages via the language switcher, both are updated.
