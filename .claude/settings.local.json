{
  "permissions": {
    "allow": [
      "Bash(bun run:*)",
      "Bash(cat:*)",
      "Bash(bun test:*)",
      "Bash(ls:*)",
      "Bash(npm info:*)",
      "Bash(timeout 120 bun run:*)",
      "Bash(timeout 30 bun run:*)",
      "Bash(bd create:*)",
      "Bash(bd list:*)",
      "Bash(xargs -I {} sh -c 'echo \"\"=== {} ===\"\" && head -7 {}')",
      "Bash(bd update vamsa-ywo --description \"$\\(cat <<''EOF''\n# GEDCOM Import/Export - Refined Implementation Plan\n\n## Overview\nImplement GEDCOM 5.5.1 standard support for family tree data exchange, enabling interoperability with other genealogy software \\(Ancestry, FamilySearch, Gramps, etc.\\).\n\n## Version Strategy\n- **Primary Target**: GEDCOM 5.5.1 Final \\(Nov 2019\\) - industry de facto standard\n- **Future**: GEDCOM 7.0 support can be added later \\(not blocking\\)\n\n---\n\n## Data Model Mapping\n\n### Vamsa -> GEDCOM\n| Vamsa               | GEDCOM Tag    | Notes                                    |\n|---------------------|---------------|------------------------------------------|\n| Person              | INDI          | Individual record                        |\n| firstName + lastName| NAME          | Full name with /surname/ delimiters      |\n| gender \\(MALE\\)       | SEX M         |                                          |\n| gender \\(FEMALE\\)     | SEX F         |                                          |\n| gender \\(OTHER\\)      | SEX X         | Non-binary/unknown                       |\n| dateOfBirth         | BIRT > DATE   | Birth event with date                    |\n| birthPlace          | BIRT > PLAC   | Birth event with place                   |\n| dateOfPassing       | DEAT > DATE   | Death event with date                    |\n| profession          | OCCU          | Occupation                               |\n| bio                 | NOTE          | Notes/biography                          |\n| isLiving            | \\(implied\\)     | DEAT present = deceased                  |\n\n### GEDCOM Nuclear Family Model -> Vamsa\nGEDCOM uses FAM \\(family\\) records to link individuals:\n- FAM record with HUSB/WIFE pointers = SPOUSE relationship in Vamsa\n- CHIL pointer in FAM = child belongs to that family\n- FAMC in INDI = \"family as child\" - links person to parents\n- FAMS in INDI = \"family as spouse\" - links person to partner\\(s\\)\n\n**Important**: HUSB/WIFE are positional, NOT gendered. Modern parsers should not infer gender from these tags.\n\n---\n\n## Supported GEDCOM Tags\n\n### Level 0 \\(Top-level records\\)\n- `HEAD` - Header with metadata \\(charset, version, source\\)\n- `INDI` - Individual person record\n- `FAM` - Family group record\n- `TRLR` - Trailer \\(end of file marker\\)\n\n### Individual \\(INDI\\) Tags\n- `NAME` - Full name \\(format: \"Given /Surname/\"\\)\n- `SEX` - Gender \\(M/F/X\\)\n- `BIRT` - Birth event\n- `DEAT` - Death event\n- `OCCU` - Occupation\n- `NOTE` - Notes/bio \\(with CONC/CONT for multiline\\)\n- `FAMC` - Family where person is child\n- `FAMS` - Family where person is spouse\n\n### Event Sub-tags\n- `DATE` - Date of event\n- `PLAC` - Place of event\n\n### Family \\(FAM\\) Tags\n- `HUSB` - Reference to partner 1\n- `WIFE` - Reference to partner 2\n- `CHIL` - Reference to child\n- `MARR` - Marriage event \\(with DATE\\)\n- `DIV` - Divorce event \\(with DATE\\)\n\n### Continuation Tags\n- `CONC` - Continuation \\(no line break\\)\n- `CONT` - Continuation with line break\n\n---\n\n## Date Format Support\n\nGEDCOM dates are flexible. Must handle:\n\n### Exact Dates\n- `1 JAN 2000` - Day Month Year\n- `JAN 2000` - Month Year only\n- `2000` - Year only\n\n### Approximate Dates\n- `ABT 1950` - About/approximately\n- `BEF 1950` - Before\n- `AFT 1950` - After\n- `BET 1950 AND 1960` - Between range\n\n### Implementation\n- Import: Parse all formats, store best available date\n- Export: Use exact format `D MMM YYYY` when full date available, `YYYY` for year-only\n\n---\n\n## Character Encoding\n\n### GEDCOM 5.5.1 Requirements\n- Support both ANSEL \\(legacy\\) and UTF-8 encodings\n- Detect encoding from HEAD > CHAR tag\n- Convert ANSEL to UTF-8 on import\n\n### Detection Strategy\n1. Read HEAD record first\n2. Check CHAR tag value: \"UTF-8\", \"ANSEL\", \"ASCII\"\n3. Default to UTF-8 if unspecified\n4. Re-decode file content if ANSEL detected\n\n### Export\n- Always export as UTF-8 \\(modern standard\\)\n- Set `1 CHAR UTF-8` in header\n\n---\n\n## Out of Scope \\(MVP\\)\n\n- **OBJE** - Multimedia objects \\(photos, documents\\)\n- **SOUR** - Source citations and references\n- **GEDZip** - Multimedia archive format\n- **GEDCOM 7.0** - Future version \\(can add later\\)\n- **REPO** - Repository records\n- **SUBM** - Submitter records \\(will use placeholder\\)\n\n---\n\n## Edge Cases to Handle\n\n1. **Same-sex partnerships**: HUSB/WIFE indicate position, not gender\n2. **Unknown genders**: Map to SEX X\n3. **Partial dates**: Year-only, month/year\n4. **People without relationships**: Export as standalone INDI\n5. **Multiple marriages**: Multiple FAMS links per person\n6. **Divorced couples**: isActive=false maps to DIV event\n7. **PREFER_NOT_TO_SAY gender**: Map to SEX X \\(or omit SEX tag\\)\n\n---\n\n## Acceptance Criteria\n\n### Import\n1. Parse valid GEDCOM 5.5.1 files\n2. Detect and handle UTF-8 and ANSEL encodings\n3. Create Person records for each INDI\n4. Create Relationship records from FAM links\n5. Handle all date formats \\(partial, approximate\\)\n6. Handle CONC/CONT continuation lines\n7. Validate file structure \\(HEAD, TRLR present\\)\n8. Return meaningful errors for invalid files\n9. Support files up to 10MB\n\n### Export\n1. Generate valid GEDCOM 5.5.1 output\n2. Export all Person records as INDI\n3. Generate FAM records for spouse relationships\n4. Include children in appropriate FAM records\n5. Use UTF-8 encoding\n6. Include proper header with source info\n\n### Roundtrip Validation\n1. Import -> Export -> Import should preserve:\n   - All person names and genders\n   - Birth/death dates and places\n   - Family relationships \\(spouse, parent-child\\)\n   - Occupations and notes\n2. Maximum acceptable data loss: 0% for supported fields\n3. Test with sample files from major genealogy software\n\n---\n\n## Files to Create/Modify\n\n### New Files\n- `src/lib/gedcom/types.ts` - GEDCOM data types\n- `src/lib/gedcom/parser.ts` - GEDCOM parser \\(import\\)\n- `src/lib/gedcom/generator.ts` - GEDCOM generator \\(export\\)\n- `src/lib/gedcom/encoding.ts` - Encoding detection/conversion\n- `src/lib/gedcom/date-parser.ts` - GEDCOM date parsing\n- `src/lib/gedcom/date-formatter.ts` - GEDCOM date formatting\n- `src/lib/gedcom/mapper.ts` - GEDCOM <-> Vamsa conversion\n- `src/actions/gedcom.ts` - Server actions\n- `src/schemas/gedcom.ts` - Validation schemas\n- `src/app/api/admin/gedcom/import/route.ts` - Import endpoint\n- `src/app/api/admin/gedcom/export/route.ts` - Export endpoint\n- `src/components/gedcom/import-dialog.tsx` - Import UI\n- `src/components/gedcom/export-button.tsx` - Export UI\n\n### Test Files\n- `src/lib/gedcom/parser.test.ts` - Parser tests\n- `src/lib/gedcom/generator.test.ts` - Generator tests\n- `src/lib/gedcom/encoding.test.ts` - Encoding tests\n- `src/lib/gedcom/date-parser.test.ts` - Date parsing tests\n- `src/lib/gedcom/date-formatter.test.ts` - Date formatting tests\n- `src/lib/gedcom/roundtrip.test.ts` - Roundtrip validation\n- `src/lib/gedcom/test-fixtures/` - Sample GEDCOM files\n\n### Modify\n- `src/app/\\(dashboard\\)/settings/page.tsx` - Add import/export UI\n\n---\n\n## Testing Strategy\n\n### Unit Tests\n- Parser: Line parsing, record building, tag handling\n- Date parser: All date formats and approximations\n- Encoding: UTF-8 detection, ANSEL conversion\n- Generator: Valid GEDCOM output structure\n- Mapper: Bidirectional data conversion\n\n### Integration Tests\n- Full import flow \\(file -> database\\)\n- Full export flow \\(database -> file\\)\n- Roundtrip preservation tests\n\n### Test Fixtures\n- Minimal valid GEDCOM \\(1 person\\)\n- Complex family \\(multiple generations\\)\n- Edge cases \\(same-sex couples, unknown genders\\)\n- Various encodings \\(UTF-8, ANSEL, ASCII\\)\n- Different date formats\n- Large file \\(100+ individuals\\)\n- Files from Ancestry, FamilySearch, Gramps \\(if available\\)\n\n---\n\n## Implementation Order\n\n1. **Phase 1: Core Parser** \\(Backend\\)\n   - Types and data structures\n   - Line-level parser\n   - Record builder\n   - Encoding detection\n\n2. **Phase 2: Date Handling** \\(Backend\\)\n   - Date parser \\(all formats\\)\n   - Date formatter \\(export\\)\n\n3. **Phase 3: Data Mapping** \\(Backend\\)\n   - GEDCOM -> Vamsa mapper\n   - Vamsa -> GEDCOM mapper\n\n4. **Phase 4: Generator** \\(Backend\\)\n   - GEDCOM file generator\n   - Header/trailer generation\n\n5. **Phase 5: Server Actions & API** \\(Backend\\)\n   - Import action with validation\n   - Export action\n   - API routes\n\n6. **Phase 6: UI Components** \\(Frontend\\)\n   - Import dialog with file picker\n   - Export button\n   - Progress/error feedback\n\n7. **Phase 7: Integration** \\(Testing\\)\n   - Roundtrip tests\n   - Edge case validation\n   - Performance testing\nEOF\n\\)\")",
      "Bash(bd dep add:*)",
      "Bash(bd show:*)",
      "Bash(bd assign:*)",
      "Bash(bd status:*)",
      "Bash(bd --help:*)",
      "Bash(bd update:*)",
      "Bash(bun -e:*)",
      "Bash(bun:*)",
      "Bash(bd comments:*)",
      "Bash(bunx prisma validate:*)",
      "Bash(eslint:*)",
      "Bash(bd comment:*)",
      "Bash(bunx eslint:*)",
      "Bash(bd set-state:*)",
      "Bash(bd state:*)",
      "Bash(timeout 45 bun run:*)",
      "Bash(timeout 60 bun run:*)",
      "Bash(timeout 90 bun run:*)",
      "Bash(bunx prisma:*)",
      "Bash(timeout 300 bun run:*)",
      "Bash(timeout 600 bun run:*)",
      "Bash(timeout 180 bun run:*)",
      "Bash(DATABASE_URL=\"postgresql://vamsa:password@localhost:5432/vamsa\" bunx prisma db push:*)",
      "Bash(timeout 180 bunx playwright test:*)",
      "Bash(timeout 60 bunx playwright test:*)",
      "Bash(git checkout:*)",
      "Bash(git add:*)",
      "Bash(xargs cat:*)"
    ]
  }
}
